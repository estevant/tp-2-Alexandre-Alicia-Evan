name: CI/CD Pipeline Script Bash

# Déclencheurs : Pousser sur main ou créer un Tag
on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # JOB 1 : TESTS (Linting et Tests fonctionnels)
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Récupération du code
        uses: actions/checkout@v3

      - name: Rendre le script exécutable
        run: chmod +x manager.sh

      - name: Test ShellCheck (Linting)
        # Vérifie la qualité du code Bash
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'

      - name: Tests Fonctionnels
        run: |
          echo "--- Test Create ---"
          ./manager.sh create "JeanDupont" | grep "Succès"
          
          echo "--- Test Update ---"
          ./manager.sh update "JeanDupont" | grep "mis à jour"
          
          echo "--- Test Delete ---"
          ./manager.sh delete "JeanDupont" | grep "supprimé"

  # JOB 2 : BUILD (Création d'une archive/artefact)
  build:
    needs: test # Attend que les tests soient passés
    runs-on: ubuntu-latest
    steps:
      - name: Récupération du code
        uses: actions/checkout@v3

      - name: Préparation de l'artefact
        run: |
          mkdir build
          cp manager.sh build/
          tar -czvf release.tar.gz build/

      - name: Upload de l'artefact
        with:
          name: bash-release
          path: release.tar.gz
  deploy:
    needs: build # Attend que le build soit fini
    if: startsWith(github.ref, 'refs/tags/') # Ne déploie que si c'est un Tag
    runs-on: ubuntu-latest
    steps:
      - name: Simulation de déploiement
          echo "Déploiement terminé avec succès !"        run: |
          echo "Copie de release.tar.gz..."
          echo "Déploiement de la version ${{ github.ref_name }} en cours..."
          echo "Connexion au serveur distant..."

  # JOB 3 : DEPLOIEMENT (Simulation)

